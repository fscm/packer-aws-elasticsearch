{
  "_copyright": "2016-2022, Frederico Martins",
  "_author":    "Frederico Martins <http://github.com/fscm>",
  "_license":   "SPDX-License-Identifier: MIT",
  "variables": {
    "aws_access_key":        "{{env `aws_access_key`}}",
    "aws_ami_name":          "elasticsearch",
    "aws_ami_name_prefix":   "",
    "aws_instance_type":     "t2.micro",
    "aws_region":            "{{env `aws_region`}}",
    "aws_secret_key":        "{{env `aws_secret_key`}}",
    "aws_ssh_username":      "admin",
    "java_build_number":     "12",
    "java_major_version":    "8",
    "java_token":            "e758a0de34e24606bca991d704f6dcbf",
    "java_update_version":   "151",
    "elasticsearch_uid":     "2010",
    "elasticsearch_version": "{{env `elasticsearch_version`}}",
    "os_short_arch":         "x64",
    "system_locale":         "en_US"
  },
  "builders": [{
    "type":                        "amazon-ebs",
    "access_key":                  "{{user `aws_access_key`}}",
    "secret_key":                  "{{user `aws_secret_key`}}",
    "region":                      "{{user `aws_region`}}",
    "instance_type":               "{{user `aws_instance_type`}}",
    "ssh_username":                "{{user `aws_ssh_username`}}",
    "associate_public_ip_address": true,
    "ami_name":                    "{{user `aws_ami_name_prefix`}}{{user `aws_ami_name`}}-{{user `elasticsearch_version`}}-({{isotime \"20060102150405\"}})",
    "source_ami_filter": {
      "filters": {
        "architecture":        "x86_64",
        "name":                "debian-jessie-*",
        "root-device-type":    "ebs",
        "virtualization-type": "hvm"
      },
      "owners":      ["379101102735"],
      "most_recent": true
    }
  }],
  "provisioners": [
    {
      "type":        "file",
      "source":      "files/sysctl/",
      "destination": "/tmp"
    },
    {
      "type":        "file",
      "source":      "files/systemd/",
      "destination": "/tmp"
    },
    {
      "type":        "file",
      "source":      "files/elasticsearch/",
      "destination": "/tmp"
    },
    {
      "type":           "shell",
      "inline_shebang": "/bin/bash -e",
      "environment_vars": [
        "DEBIAN_FRONTEND=noninteractive"
      ],
      "inline": [
        "unset HISTFILE",
        "history -cw",
        "echo === Waiting for Cloud-Init ===",
        "timeout 180 /bin/bash -c 'until stat /var/lib/cloud/instance/boot-finished &>/dev/null; do echo waiting...; sleep 6; done'",
        "echo === System Packages ===",
        "echo 'deb http://ftp.debian.org/debian jessie-backports main contrib non-free' | sudo tee /etc/apt/sources.list.d/backports.list > /dev/null",
        "sudo apt-get -qq update",
        "sudo apt-get -y -qq install --no-install-recommends apt-transport-https apt-show-versions bash-completion logrotate ntp ntpdate htop vim wget curl dbus bmon nmon parted wget curl sudo rsyslog ethtool unzip zip telnet tcpdump strace tar libyaml-0-2 lsb-base lsb-release xfsprogs sysfsutils",
        "sudo apt-get -y -qq --purge autoremove",
        "sudo apt-get autoclean",
        "sudo apt-get clean",
        "echo === System Settings ===",
        "echo 'dash dash/sh boolean false' | sudo debconf-set-selections",
        "sudo dpkg-reconfigure -f noninteractive dash",
        "sudo update-locale LC_CTYPE={{user `system_locale`}}.UTF-8",
        "echo 'export TZ=:/etc/localtime' | sudo tee /etc/profile.d/tz.sh > /dev/null",
        "sudo update-alternatives --set editor /usr/bin/vim.basic",
        "echo === Sysctl ===",
        "sudo cp /tmp/50-elasticsearch.conf /etc/sysctl.d/",
        "sudo chown root:root /etc/sysctl.d/50-elasticsearch.conf",
        "sudo chmod 0644 /etc/sysctl.d/50-elasticsearch.conf",
        "sudo sysctl -p /etc/sysctl.d/50-elasticsearch.conf",
        "echo === Java ===",
        "sudo mkdir /opt/java",
        "curl -sL --retry 3 --insecure --header 'Cookie: oraclelicense=accept-securebackup-cookie;' 'http://download.oracle.com/otn-pub/java/jdk/{{user `java_major_version`}}u{{user `java_update_version`}}-b{{user `java_build_number`}}/{{user `java_token`}}/jre-{{user `java_major_version`}}u{{user `java_update_version`}}-linux-{{user `os_short_arch`}}.tar.gz' | sudo tar xz --strip-components=1 -C /opt/java/",
        "sudo chown -R root:root /opt/java",
        "echo 'export JAVA_HOME=/opt/java' | sudo tee /etc/profile.d/java.sh > /dev/null",
        "sudo sed -i -r -e 's/#DefaultEnvironment/DefaultEnvironment/;/DefaultEnvironment/s/([^=])$/\\1 /;/DefaultEnvironment/s|$|\"JAVA_HOME=/opt/java\"|' /etc/systemd/system.conf",
        "sudo gzip -r /opt/java/man/man1",
        "for program in /opt/java/bin/*; do name=${program##*/}; manpage=''; [[ -f /opt/java/man/man1/${name}.1.gz ]] && manpage=\"--slave /usr/share/man/man1/${name}.1.gz ${name}.1.gz /opt/java/man/man1/${name}.1.gz\"; [[ -x ${program} && ! -L ${program} ]] && sudo update-alternatives --install /usr/bin/${name} ${name} /opt/java/bin/${name} 1 ${manpage}; done",
        "echo === Elasticsearch ===",
        "sudo groupadd -g {{user `elasticsearch_uid`}} elasticsearch",
        "sudo useradd -m -u {{user `elasticsearch_uid`}} -g {{user `elasticsearch_uid`}} -c 'Elasticsearch' -s /bin/bash -d /srv/elasticsearch elasticsearch",
        "curl -sL --retry 3 --insecure 'https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-{{user `elasticsearch_version`}}.tar.gz' | sudo tar xz --strip-components=1 -C /srv/elasticsearch/",
        "sudo mkdir -p /data/elasticsearch",
        "sudo mkdir -p /var/{log,run}/elasticsearch",
        "sudo ln -s /var/log/elasticsearch /srv/elasticsearch/logs",
        "sudo ln -s /data/elasticsearch /srv/elasticsearch/data",
        "echo -e \"\\n__DEFAULT_MEM__=\\$(/usr/bin/awk '/MemTotal/{m=\\$2*.60;print int(m)\\\"k\\\"}' /proc/meminfo)\\nES_JAVA_OPTS=\\\"-Xms\\${__DEFAULT_MEM__} \\$ES_JAVA_OPTS\\\"\\nES_JAVA_OPTS=\\\"-Xmx\\${__DEFAULT_MEM__} \\$ES_JAVA_OPTS\\\"\" | sudo tee -a /srv/elasticsearch/bin/elasticsearch.in.sh > /dev/null",
        "sudo sed -i -r -e '/^-Xms/i## IMPORTANT: Use the bin\\/elasticsearch.in.sh file instead to change the JVM heap size.' /srv/elasticsearch/config/jvm.options",
        "sudo sed -i -r -e '/^-Xms/s/^/#/' /srv/elasticsearch/config/jvm.options",
        "sudo sed -i -r -e '/^-Xmx/s/^/#/' /srv/elasticsearch/config/jvm.options",
        "sudo sed -i -r -e '/^#/! {/HeapDumpOnOutOfMemoryError/s/^/#/}' /srv/elasticsearch/config/jvm.options",
        "sudo sed -i -r -e 's/# *cluster.name:/cluster.name:/;/^cluster.name:/s/:.*/: es-cluster/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *node.name:/node.name:/;/^node.name:/s/:.*/: ${HOSTNAME}/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *path.data:/path.data:/;/^path.data:/s|:.*|: /data/elasticsearch|' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *path.logs:/path.logs:/;/^path.logs:/s|:.*|: /var/log/elasticsearch|' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *bootstrap.memory_lock:/bootstrap.memory_lock:/;/^bootstrap.memory_lock:/s/:.*/: true/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/#* *network.host:/#network.host:/;/^#network.host:/a network.bind_host: 0.0.0.0\\nnetwork.publish_host: localhost' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *http.port:/http.port:/;/^http.port:/s/:.*/: 9200/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *discovery.zen.ping.unicast.hosts:/discovery.zen.ping.unicast.hosts:/;/^discovery.zen.ping.unicast.hosts:/s/:.*/: [\"localhost\"]/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *discovery.zen.minimum_master_nodes:/discovery.zen.minimum_master_nodes:/;/^discovery.zen.minimum_master_nodes:/s/:.*/: 1/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *gateway.recover_after_nodes:/gateway.recover_after_nodes:/;/^gateway.recover_after_nodes:/s/:.*/: 1/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e 's/# *action.destructive_requires_name:/action.destructive_requires_name:/;/^action.destructive_requires_name:/s/:.*/: true/' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e '/http.cors.enabled:/{h;s/#*http.cors.enabled:.*/http.cors.enabled: true/};${x;/^$/{s//\\nhttp.cors.enabled: true/;H};x}' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo sed -i -r -e '/http.cors.allow-origin:/{h;s|#*http.cors.allow-origin:.*|http.cors.allow-origin: /https?:\\\\/\\\\/localhost(:[0-9]+)?/|};${x;/^$/{s||\\nhttp.cors.allow-origin: /https?:\\\\/\\\\/localhost(:[0-9]+)?/|;H};x}' /srv/elasticsearch/config/elasticsearch.yml",
        "sudo /srv/elasticsearch/bin/elasticsearch-plugin install analysis-icu",
        "sudo /srv/elasticsearch/bin/elasticsearch-plugin list",
        "sudo chown -R elasticsearch:elasticsearch /srv/elasticsearch /data/elasticsearch /var/log/elasticsearch /var/run/elasticsearch",
        "sudo cp /tmp/elasticsearch.service /lib/systemd/system/",
        "sudo systemctl daemon-reload",
        "sudo systemctl disable elasticsearch.service",
        "sudo cp /tmp/elasticsearch_config /usr/local/bin/",
        "sudo chown root:staff /usr/local/bin/elasticsearch_config",
        "sudo chmod 0755 /usr/local/bin/elasticsearch_config",
        "echo '5 4 * * *    elasticsearch    /usr/bin/find /var/log/elasticsearch -type f -mtime +15 -exec rm -f {} + &> /dev/null' | sudo tee /etc/cron.d/elasticsearch > /dev/null",
        "echo === Extra System Settings ===",
        "sudo sed -r -i -e 's/.*(GRUB_CMDLINE_LINUX_DEFAULT)=\"(.*)\"/\\1=\"\\2 elevator=deadline\"/' /etc/default/grub",
        "sudo update-grub2",
        "echo === System Cleanup ===",
        "sudo rm -f /root/.bash_history",
        "sudo rm -f /home/{{user `aws_ssh_username`}}/.bash_history",
        "sudo rm -f /var/log/wtmp",
        "sudo rm -f /var/log/btmp",
        "sudo rm -rf /var/log/installer",
        "sudo rm -rf /var/lib/cloud/instances",
        "sudo rm -rf /tmp/* /var/tmp/* /tmp/.*-unix",
        "sudo find /var/cache -type f -delete",
        "sudo find /var/log -type f | while read f; do echo -n '' | sudo tee $f > /dev/null; done;",
        "sudo find /var/lib/apt/lists -not -name lock -type f -delete",
        "sudo sync",
        "echo === All Done ==="
      ]
    }
  ]
}
